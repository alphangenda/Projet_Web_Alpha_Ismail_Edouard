{% extends 'base.html' %}
{% load static %}

{% block title %}Map de location - EcoFlex{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Carte interactive - EcoFlex</h2>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Filtrer par distance depuis votre position</h5>
            <form id="formulaireFiltre" class="row g-3">
                <div class="col-md-4">
                    <label for="adresse" class="form-label">Adresse ou lieu</label>
                    <input type="text" class="form-control" id="adresse" placeholder="Ex: 325 boulevard Charest Est, Québec">
                </div>
                <div class="col-md-3">
                    <label for="distanceMax" class="form-label">Distance maximale (km)</label>
                    <select class="form-select" id="distanceMax">
                        <option value="1000">Tous les véhicules</option>
                        <option value="0.5">0.5 km</option>
                        <option value="1" selected>1 km</option>
                        <option value="2">2 km</option>
                        <option value="5">5 km</option>
                        <option value="10">10 km</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="typeVehicule" class="form-label">Type de véhicule</label>
                    <select class="form-select" id="typeVehicule">
                        <option value="">Tous</option>
                        <option value="velo">Vélo</option>
                        <option value="trottinette">Trottinette</option>
                        <option value="voiture">Voiture</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-success w-100">Rechercher</button>
                </div>
            </form>
            <div class="mt-2">
                <button id="utiliserMaPosition" class="btn btn-outline-success btn-sm">
                    Utiliser ma position actuelle
                </button>
            </div>
        </div>
    </div>

    <div id="resultatsRecherche" class="alert alert-info" style="display: none;">
        <strong>Résultats :</strong> <span id="nombreResultats">0</span> véhicule(s) trouvé(s)
    </div>

    <div id="map" style="height: 600px; border-radius: 12px;"></div>

    <div class="alert alert-info text-center mt-4" role="alert">
        Vous pouvez zoomer, dézoomer et vous déplacer sur la carte de Québec.
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var map = L.map('map').setView([46.8139, -71.2080], 13);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors & Carto'
    }).addTo(map);

    L.marker([46.8139, -71.2080])
      .addTo(map)
      .bindPopup("<b>EcoFlex Québec</b><br>Centre-ville de Québec.")
      .openPopup();

    var marqueurs = [];

    fetch("/api/stations/")
        .then(function(response) {
                return response.json();
            })
        .then(function(data){
            for (var i=0; i<data.length; i++) {
                var station = data[i];
                var marker = L.marker([station.latitude, station.longitude]).addTo(map);
                marker.bindPopup(
                    "<b>" + station.nom + "</b><br>" + "Type : " + station.type_vehicule + "<br>" + "Capacité : " + station.capacite
                );
                marqueurs.push(marker);
            }

            if (window.initialiserFiltre) {
                window.initialiserFiltre(map);
            }
            if (window.sauvegarderMarqueursOriginaux) {
                window.sauvegarderMarqueursOriginaux(marqueurs);
            }
        })
        .catch(function(error) {
            console.error("Erreur lors du chargement des stations :", error);
        });
});
</script>

<script src="{% static 'ecoflex/js/filtre_map_position.js' %}"></script>
{% endblock %}